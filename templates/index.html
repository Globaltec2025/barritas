<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>Generador de C√≥digo de Barras</title>
</head>
<body>
    <div id="loadingScreen" style="display: none;">
        <div class="spinner"></div>
        <p>BUSCANDO...</p>
    </div>    
    <div id="container">
        <img src="{{ url_for('static', filename='imagenes/logo-globaltec.png') }}" alt="Logo Globaltec" class="header-image">
        
        <!-- Secci√≥n inicial de b√∫squeda -->
        <div id="searchSection" style="display: block;">
            <div class="input-container">
                <label for="codeInput" class="label-codeInput">CODIGO<br>SAP</label>
                <input type="text" id="codeInput" placeholder="Ingresa el c√≥digo" aria-label="C√≥digo SAP">
                <button id="searchButton" onclick="searchCode()">BUSCAR</button>
            </div>
        </div>

        <!-- Secci√≥n de resultados (inicialmente oculta) -->
        <div id="resultSection" style="display: none;">
            <div class="result-container">
                <div class="code-display">
                    <label>CODIGO<br>SAP</label>
                    <span id="codeDisplay"></span>
                </div>

                <div class="quantity-input">
                    <label for="quantityInput">CANTIDAD</label>
                    <input type="number" id="quantityInput" min="1" value="1">
                </div>

                <div class="description-display">
                    <label>DESCRIPCI√ìN:</label>
                    <p id="descriptionDisplay"></p>
                </div>

                <button id="btnConnect">Conectar Impresora</button>
                <button id="btnPrintEscPos">Imprimir PDF (TSC)</button>

                <!-- <div class="button-container">
                    <button onclick="imprimirPDF()">IMPRIMIR</button>
                </div>-->

                <div id="backButtonContainer">
                    <button onclick="goBack()">REGRESAR</button>
                </div>
            </div>
        </div>

        <p id="errorMessage" class="error-message" role="alert"></p>
        <p id="successMessage" class="success-message" role="status"></p>
    </div>

    <script>

        // Funci√≥n de b√∫squeda del c√≥digo
        function searchCode() {
            const code = document.getElementById('codeInput').value;
            document.getElementById('loadingScreen').style.display = 'flex'; // Mostrar pantalla de carga
            fetch(`/buscar?codigo=${code}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingScreen').style.display = 'none'; // Ocultar pantalla de carga
                    if (data.error) {
                        document.getElementById('errorMessage').textContent = data.error;
                        document.getElementById('resultSection').style.display = 'none';
                    } else {
                        document.getElementById('codeDisplay').textContent = data.code;
                        document.getElementById('descriptionDisplay').textContent = data.description;
                        document.getElementById('resultSection').style.display = 'block';
                        document.getElementById('errorMessage').textContent = '';

                        // Guardar marca y medida en variables ocultas
                        document.getElementById('codeDisplay').dataset.marca = data.marca;
                        document.getElementById('codeDisplay').dataset.medida = data.medida;

                        // Ocultar el bot√≥n de b√∫squeda y el contenedor de entrada
                        document.getElementById('searchButton').style.display = 'none';
                        document.querySelector('.input-container').style.display = 'none';
                    }
                })
                .catch(error => {
                    document.getElementById('loadingScreen').style.display = 'none'; // Ocultar pantalla de carga
                    document.getElementById('errorMessage').textContent = 'Error al buscar el c√≥digo.';
                    document.getElementById('resultSection').style.display = 'none';
                });
        }

        // Funci√≥n para regresar a la pantalla de b√∫squeda
        function goBack() {
            // Ocultar la secci√≥n de resultados
            document.getElementById('resultSection').style.display = 'none';

            // Mostrar la secci√≥n de b√∫squeda
            const searchSection = document.getElementById('searchSection');
            searchSection.style.display = 'flex';
            searchSection.style.flexDirection = 'column';
            searchSection.style.alignItems = 'center';
            searchSection.style.justifyContent = 'center';

            // Restaurar cualquier estilo del contenedor principal
            const container = document.getElementById('container');
            container.style.flexDirection = 'column';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';

            // Limpiar mensajes y campos
            document.getElementById('codeInput').value = '';
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('successMessage').textContent = '';

            // Mostrar bot√≥n de b√∫squeda
            document.getElementById('searchButton').style.display = 'inline-block';
            document.querySelector('.input-container').style.display = 'flex';
        }

        let printerCharacteristic = null;

        async function connectPrinter() {
            try {
                console.log("üîç Buscando impresora...");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ["000018f0-0000-1000-8000-00805f9b34fb"]
                });

                console.log("üì° Dispositivo seleccionado:", device.name);
                const server = await device.gatt.connect();
                console.log("‚úÖ Conectado a:", device.name);

                const service = await server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb");
                console.log("üîç Servicio obtenido:", service);

                const characteristics = await service.getCharacteristics();
                console.log("üìù Caracter√≠sticas disponibles:", characteristics.map(c => c.uuid));

                // Seleccionar la caracter√≠stica de escritura
                printerCharacteristic = characteristics.find(c => c.properties.write);
                if (!printerCharacteristic) {
                    throw new Error("No se encontr√≥ una caracter√≠stica de escritura.");
                }

                console.log("‚úÖ Caracter√≠stica de escritura lista:", printerCharacteristic.uuid);
                alert("¬°Impresora conectada!");
            } catch (error) {
                console.error("‚ùå Error al conectar la impresora:", error);
                alert("Error al conectar la impresora.");
            }
        }

        async function printTSC() {
            if (!printerCharacteristic || !printerCharacteristic.service.device.gatt.connected) {
                alert("‚ö†Ô∏è La impresora no est√° conectada.");
                return;
            }

            try {
                const code = document.getElementById('codeDisplay').textContent || "N/A";
                const marca = document.getElementById('codeDisplay').dataset.marca || "Sin marca";
                const medida = document.getElementById('codeDisplay').dataset.medida || "Sin medida";
                let description = document.getElementById('descriptionDisplay').textContent || "Sin descripci√≥n";
                const cantidad = parseInt(document.getElementById('quantityInput').value) || 1;

                // üîÑ Reemplazar caracteres especiales y evitar errores con comillas dobles
                const reemplazos = {
                    "√±": "n", "√ë": "N",
                    "√°": "a", "√©": "e", "√≠": "i", "√≥": "o", "√∫": "u",
                    "√Å": "A", "√â": "E", "√ç": "I", "√ì": "O", "√ö": "U"
                };
                description = description.replace(/[√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö]/g, c => reemplazos[c] || c);
                description = description.replace(/"/g, "'"); // Evitar errores con comillas dobles

                // üîπ Forzar solo DOS l√≠neas dividiendo el texto
                function dividirTexto(texto, maxLength) {
                    let palabras = texto.split(" ");
                    let lineas = ["", ""];

                    let lineaIndex = 0;

                    for (let palabra of palabras) {
                        if ((lineas[lineaIndex] + palabra).length > maxLength) {
                            if (lineaIndex === 1) {
                                lineas[lineaIndex] += " " + palabra; // Si ya es la segunda l√≠nea, forzar el texto ah√≠
                            } else {
                                lineaIndex++; // Pasar a la segunda l√≠nea
                                lineas[lineaIndex] = palabra;
                            }
                        } else {
                            lineas[lineaIndex] += (lineas[lineaIndex] ? " " : "") + palabra;
                        }
                    }

                    return lineas.map(l => l.trim());
                }

                const lineasTexto = dividirTexto(description, 40); // Max 40 caracteres por l√≠nea

                // üîπ Construir comandos TSC
                let commands = [
                    "SIZE 76 mm, 25 mm\r\n",
                    "GAP 2 mm, 0 mm\r\n",
                    "DIRECTION 1\r\n",
                    "CLS\r\n"
                ];

                for (let i = 0; i < cantidad; i++) {
                    let y = 7; // Posici√≥n inicial para la descripci√≥n

                    // üìå Imprimir cada l√≠nea en una nueva posici√≥n Y
                    for (const linea of lineasTexto) {
                        if (linea) {
                            commands.push(`TEXT 4,${y},"1",0,1,1,"${linea}"\r\n`);
                            y += 20; // Mover hacia abajo para la siguiente l√≠nea
                        }
                    }

                    // üìå C√≥digo de barras y dem√°s elementos
                    commands.push(`BARCODE 4,${y-2},"128",100,0,0,7,2,"${code}"\r\n`);
                    commands.push(`TEXT 190,${y + 100},"3",0,1,1,"${code}"\r\n`);
                    commands.push(`TEXT 1,${y + 125},"2",0,1,1,"${medida}"\r\n`);
                    commands.push(`TEXT 440,${y + 125},"2",0,1,1,"${marca}"\r\n`);
                    commands.push("PRINT 1,1\r\n");
                }

                console.log("üì§ Enviando impresi√≥n");

                // üîπ Enviar los comandos en partes peque√±as con pausas
                for (const command of commands) {
                    if (!printerCharacteristic.service.device.gatt.connected) {
                        alert("‚ö†Ô∏è La impresora se ha desconectado.");
                        return;
                    }
                    await printerCharacteristic.writeValue(new TextEncoder().encode(command));
                    await new Promise(resolve => setTimeout(resolve, 50)); // Peque√±a pausa entre env√≠os
                }

                console.log("‚úÖ Impresi√≥n enviada correctamente");
                alert("¬°Impresi√≥n enviada en TSC!");

            } catch (error) {
                console.error("‚ùå Error de impresi√≥n:", error);
                alert("Error al enviar la impresi√≥n.");
            }
        }
        
        document.getElementById("btnConnect").addEventListener("click", connectPrinter);
        document.getElementById("btnPrintEscPos").addEventListener("click", printTSC);
    </script>
</body>
</html>